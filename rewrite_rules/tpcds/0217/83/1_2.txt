Factor out common filtering logic into a separate common table expression: Reduces duplicate computation and focuses the filter evaluation.