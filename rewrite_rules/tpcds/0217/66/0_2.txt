Isolate similar pre-aggregation logic into separate CTEs: Reduces redundant code and simplifies maintenance.