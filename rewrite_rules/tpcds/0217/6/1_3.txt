Replace a correlated subquery with a CTE for aggregated values: minimizes repeated computation and improves performance.