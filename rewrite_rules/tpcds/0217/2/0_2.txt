Consolidate repeated table filtering into a single aggregated CTE: Reduces redundant scans and accelerates the aggregation phase.