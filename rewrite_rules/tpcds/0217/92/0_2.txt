Factor out the correlated subquery into a separate aggregated result (using a CTE): Avoids repeated computation and improves performance.