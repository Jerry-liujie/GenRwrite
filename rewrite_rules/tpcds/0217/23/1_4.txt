Replace scalar subqueries with CTEs: Improves clarity and enables potential materialization of intermediate aggregations.