Use common table expressions (CTEs) to precompute aggregates: This modularizes the query and simplifies debugging and optimization.