SELECT t2.s_store_name, t2.s_company_name, t2.d_year, t2.avg_monthly_sales, t2.sum_sales, t6.sum_sales AS psum, t10.sum_sales AS nsum FROM (SELECT t1.i_category, t1.i_brand, t1.s_store_name, t1.s_company_name, t1.d_year, t1.d_moy, t1.sum_sales, (SUM(t1.sum_sales) OVER (PARTITION BY t1.i_category, t1.i_brand, t1.s_store_name, t1.s_company_name, t1.d_year RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)) / (COUNT(t1.sum_sales) OVER (PARTITION BY t1.i_category, t1.i_brand, t1.s_store_name, t1.s_company_name, t1.d_year RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)) AS avg_monthly_sales, RANK() OVER (PARTITION BY t1.i_category, t1.i_brand, t1.s_store_name, t1.s_company_name ORDER BY t1.d_year, t1.d_moy) AS rn FROM (SELECT item.i_category, item.i_brand, store.s_store_name, store.s_company_name, t.d_year, t.d_moy, SUM(store_sales.ss_sales_price) AS sum_sales FROM item INNER JOIN store_sales ON item.i_item_sk = store_sales.ss_item_sk INNER JOIN (SELECT * FROM date_dim WHERE d_year = 2000 OR d_year = 2000 - 1 AND d_moy = 12 OR d_year = 2000 + 1 AND d_moy = 1) AS t ON store_sales.ss_sold_date_sk = t.d_date_sk INNER JOIN store ON store_sales.ss_store_sk = store.s_store_sk GROUP BY item.i_category, item.i_brand, store.s_store_name, store.s_company_name, t.d_year, t.d_moy) AS t1) AS t2 INNER JOIN (SELECT t5.i_category, t5.i_brand, t5.s_store_name, t5.s_company_name, t5.d_year, t5.d_moy, t5.sum_sales, (SUM(t5.sum_sales) OVER (PARTITION BY t5.i_category, t5.i_brand, t5.s_store_name, t5.s_company_name, t5.d_year RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)) / (COUNT(t5.sum_sales) OVER (PARTITION BY t5.i_category, t5.i_brand, t5.s_store_name, t5.s_company_name, t5.d_year RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)) AS avg_monthly_sales, RANK() OVER (PARTITION BY t5.i_category, t5.i_brand, t5.s_store_name, t5.s_company_name ORDER BY t5.d_year, t5.d_moy) AS rn FROM (SELECT item0.i_category, item0.i_brand, store0.s_store_name, store0.s_company_name, t3.d_year, t3.d_moy, SUM(store_sales0.ss_sales_price) AS sum_sales FROM item AS item0 INNER JOIN store_sales AS store_sales0 ON item0.i_item_sk = store_sales0.ss_item_sk INNER JOIN (SELECT * FROM date_dim WHERE d_year = 2000 OR d_year = 2000 - 1 AND d_moy = 12 OR d_year = 2000 + 1 AND d_moy = 1) AS t3 ON store_sales0.ss_sold_date_sk = t3.d_date_sk INNER JOIN store AS store0 ON store_sales0.ss_store_sk = store0.s_store_sk GROUP BY item0.i_category, item0.i_brand, store0.s_store_name, store0.s_company_name, t3.d_year, t3.d_moy) AS t5) AS t6 ON t2.i_category = t6.i_category AND t2.i_brand = t6.i_brand AND t2.s_store_name = t6.s_store_name AND t2.s_company_name = t6.s_company_name AND t2.rn = t6.rn + 1 INNER JOIN (SELECT t9.i_category, t9.i_brand, t9.s_store_name, t9.s_company_name, t9.d_year, t9.d_moy, t9.sum_sales, (SUM(t9.sum_sales) OVER (PARTITION BY t9.i_category, t9.i_brand, t9.s_store_name, t9.s_company_name, t9.d_year RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)) / (COUNT(t9.sum_sales) OVER (PARTITION BY t9.i_category, t9.i_brand, t9.s_store_name, t9.s_company_name, t9.d_year RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)) AS avg_monthly_sales, RANK() OVER (PARTITION BY t9.i_category, t9.i_brand, t9.s_store_name, t9.s_company_name ORDER BY t9.d_year, t9.d_moy) AS rn FROM (SELECT item1.i_category, item1.i_brand, store1.s_store_name, store1.s_company_name, t7.d_year, t7.d_moy, SUM(store_sales1.ss_sales_price) AS sum_sales FROM item AS item1 INNER JOIN store_sales AS store_sales1 ON item1.i_item_sk = store_sales1.ss_item_sk INNER JOIN (SELECT * FROM date_dim WHERE d_year = 2000 OR d_year = 2000 - 1 AND d_moy = 12 OR d_year = 2000 + 1 AND d_moy = 1) AS t7 ON store_sales1.ss_sold_date_sk = t7.d_date_sk INNER JOIN store AS store1 ON store_sales1.ss_store_sk = store1.s_store_sk GROUP BY item1.i_category, item1.i_brand, store1.s_store_name, store1.s_company_name, t7.d_year, t7.d_moy) AS t9) AS t10 ON t2.i_category = t10.i_category AND t2.i_brand = t10.i_brand AND t2.s_store_name = t10.s_store_name AND t2.s_company_name = t10.s_company_name AND t2.rn = t10.rn - 1 WHERE t2.d_year = 2000 AND t2.avg_monthly_sales > 0 AND CASE WHEN t2.avg_monthly_sales > 0 THEN ABS(t2.sum_sales - t2.avg_monthly_sales) / t2.avg_monthly_sales > 0.1 ELSE FALSE END ORDER BY t2.sum_sales - t2.avg_monthly_sales, t10.sum_sales LIMIT 100