SELECT t2.ss_customer_sk, ROUND(t2.ss_qty / (CASE WHEN t5.ws_qty IS NOT NULL THEN CAST(t5.ws_qty AS INTEGER) ELSE 0 END + CASE WHEN t8.cs_qty IS NOT NULL THEN CAST(t8.cs_qty AS INTEGER) ELSE 0 END), 2) AS ratio, t2.ss_qty AS store_qty, t2.ss_wc AS store_wholesale_cost, t2.ss_sp AS store_sales_price, CASE WHEN t5.ws_qty IS NOT NULL THEN CAST(t5.ws_qty AS INTEGER) ELSE 0 END + CASE WHEN t8.cs_qty IS NOT NULL THEN CAST(t8.cs_qty AS INTEGER) ELSE 0 END AS other_chan_qty, CASE WHEN t5.ws_wc IS NOT NULL THEN CAST(t5.ws_wc AS DECIMAL(19, 0)) ELSE 0 END + CASE WHEN t8.cs_wc IS NOT NULL THEN CAST(t8.cs_wc AS DECIMAL(19, 0)) ELSE 0 END AS other_chan_wholesale_cost, CASE WHEN t5.ws_sp IS NOT NULL THEN CAST(t5.ws_sp AS DECIMAL(19, 0)) ELSE 0 END + CASE WHEN t8.cs_sp IS NOT NULL THEN CAST(t8.cs_sp AS DECIMAL(19, 0)) ELSE 0 END AS other_chan_sales_price FROM (SELECT date_dim.d_year AS ss_sold_year, t.ss_item_sk, t.ss_customer_sk, SUM(t.ss_quantity) AS ss_qty, SUM(t.ss_wholesale_cost) AS ss_wc, SUM(t.ss_sales_price) AS ss_sp FROM (SELECT * FROM store_sales LEFT JOIN store_returns ON store_sales.ss_ticket_number = store_returns.sr_ticket_number AND store_sales.ss_item_sk = store_returns.sr_item_sk WHERE store_returns.sr_ticket_number IS NULL) AS t INNER JOIN date_dim ON t.ss_sold_date_sk = date_dim.d_date_sk GROUP BY date_dim.d_year, t.ss_item_sk, t.ss_customer_sk HAVING date_dim.d_year = 1998) AS t2 LEFT JOIN (SELECT date_dim0.d_year AS ws_sold_year, t3.ws_item_sk, t3.ws_bill_customer_sk AS ws_customer_sk, SUM(t3.ws_quantity) AS ws_qty, SUM(t3.ws_wholesale_cost) AS ws_wc, SUM(t3.ws_sales_price) AS ws_sp FROM (SELECT * FROM web_sales LEFT JOIN web_returns ON web_sales.ws_order_number = web_returns.wr_order_number AND web_sales.ws_item_sk = web_returns.wr_item_sk WHERE web_returns.wr_order_number IS NULL) AS t3 INNER JOIN date_dim AS date_dim0 ON t3.ws_sold_date_sk = date_dim0.d_date_sk GROUP BY date_dim0.d_year, t3.ws_item_sk, t3.ws_bill_customer_sk) AS t5 ON t2.ss_sold_year = t5.ws_sold_year AND t2.ss_item_sk = t5.ws_item_sk AND t2.ss_customer_sk = t5.ws_customer_sk LEFT JOIN (SELECT date_dim1.d_year AS cs_sold_year, t6.cs_item_sk, t6.cs_bill_customer_sk AS cs_customer_sk, SUM(t6.cs_quantity) AS cs_qty, SUM(t6.cs_wholesale_cost) AS cs_wc, SUM(t6.cs_sales_price) AS cs_sp FROM (SELECT * FROM catalog_sales LEFT JOIN catalog_returns ON catalog_sales.cs_order_number = catalog_returns.cr_order_number AND catalog_sales.cs_item_sk = catalog_returns.cr_item_sk WHERE catalog_returns.cr_order_number IS NULL) AS t6 INNER JOIN date_dim AS date_dim1 ON t6.cs_sold_date_sk = date_dim1.d_date_sk GROUP BY date_dim1.d_year, t6.cs_item_sk, t6.cs_bill_customer_sk) AS t8 ON t2.ss_sold_year = t8.cs_sold_year AND t2.ss_item_sk = t8.cs_item_sk AND t2.ss_customer_sk = t8.cs_customer_sk WHERE CASE WHEN t5.ws_qty IS NOT NULL THEN CAST(t5.ws_qty AS INTEGER) ELSE 0 END > 0 OR CASE WHEN t8.cs_qty IS NOT NULL THEN CAST(t8.cs_qty AS INTEGER) ELSE 0 END > 0 ORDER BY t2.ss_customer_sk, t2.ss_qty DESC, t2.ss_wc DESC, t2.ss_sp DESC, CASE WHEN t5.ws_qty IS NOT NULL THEN CAST(t5.ws_qty AS INTEGER) ELSE 0 END + CASE WHEN t8.cs_qty IS NOT NULL THEN CAST(t8.cs_qty AS INTEGER) ELSE 0 END, CASE WHEN t5.ws_wc IS NOT NULL THEN CAST(t5.ws_wc AS DECIMAL(19, 0)) ELSE 0 END + CASE WHEN t8.cs_wc IS NOT NULL THEN CAST(t8.cs_wc AS DECIMAL(19, 0)) ELSE 0 END, CASE WHEN t5.ws_sp IS NOT NULL THEN CAST(t5.ws_sp AS DECIMAL(19, 0)) ELSE 0 END + CASE WHEN t8.cs_sp IS NOT NULL THEN CAST(t8.cs_sp AS DECIMAL(19, 0)) ELSE 0 END, ROUND(t2.ss_qty / (CASE WHEN t5.ws_qty IS NOT NULL THEN CAST(t5.ws_qty AS INTEGER) ELSE 0 END + CASE WHEN t8.cs_qty IS NOT NULL THEN CAST(t8.cs_qty AS INTEGER) ELSE 0 END), 2) LIMIT 100